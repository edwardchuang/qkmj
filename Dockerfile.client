# Stage 1: Build QKMJ Client
FROM alpine:latest AS builder

RUN apk add --no-cache \
    build-base \
    cmake \
    pkgconf \
    git \
    ncurses-dev \
    cjson-dev \
    curl-dev \
    mongo-c-driver-dev \
    linux-headers

WORKDIR /src
# Copy everything including .git (needed for GIT_HASH in CMake)
COPY . .

# Build only the client target (qkmj)
RUN cmake -S . -B build -DCMAKE_BUILD_TYPE=Release \
    && cmake --build build --target qkmj

# Stage 2: Runtime with TTYD
FROM alpine:latest

# Install runtime deps and ttyd
# ttyd is available in community repo
RUN apk add --no-cache \
    ttyd \
    ncurses-libs \
    cjson \
    libcurl \
    ca-certificates

WORKDIR /app

# Copy compiled client and the optimized HTML template
COPY --from=builder /src/build/qkmj .
COPY web/index.html index.html

# Environment variables for connection
ENV SERVER_IP="127.0.0.1"
ENV SERVER_PORT="7001"
ENV PORT=8080

# Expose the web port
EXPOSE 8080

# Run ttyd which launches qkmj
# -W: Writeable (allows input)
# -p: Port
# -i: Use our custom index.html
# qkmj arguments: IP PORT
CMD ["/bin/sh", "-c", "exec ttyd -W -p ${PORT} -i index.html ./qkmj ${SERVER_IP} ${SERVER_PORT}"]
